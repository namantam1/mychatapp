"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function ownKeys(t,e){var a,n=Object.keys(t);return Object.getOwnPropertySymbols&&(a=Object.getOwnPropertySymbols(t),e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,a)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _instanceof(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!_instanceof(e,t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(a){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(a);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var encodeRoomId=function(e){return"room_"+e},isTabActive=!0,audio=new Audio("/static/sound.mp3");function playSound(){audio.play().then().catch(function(e){})}function ListItem(e){var t=e.value.user.online?React.createElement("div",null,React.createElement("i",{className:"fa fa-circle online"})," Online"):React.createElement("div",null,React.createElement("i",{className:"fa fa-circle offline"})," offline");return React.createElement("li",{className:e.value.isActive?"clearfix active":"clearfix","data-room":e.value.roomId,onClick:function(){return e.action(e.value.roomId,!0)}},React.createElement("img",{src:e.value.user.image,alt:"avatar"}),React.createElement("div",{className:"about"},React.createElement("div",{className:"name"},"Chat-",e.value.roomId),React.createElement("div",{className:"status"},t)),0!==e.value.unseenCount?React.createElement("small",null,e.value.unseenCount):"")}function Reply(e){return React.createElement("li",{className:"clearfix",id:"chat-id"},React.createElement("div",{className:"message-data align-right"},React.createElement("span",{className:"message-data-time"},e.value.timestamp),"    ",React.createElement("span",{className:"message-data-name"},e.value.name)," ",React.createElement("i",{className:"fa fa-circle me"})),React.createElement("div",{className:"message other-message float-right"},e.value.text,React.createElement("i",{className:e.value.seen?"fas fa-check-double status":"fas fa-check status"})))}function Response(e){return React.createElement("li",{id:"chat-id"},React.createElement("div",{className:"message-data"},React.createElement("span",{className:"message-data-name"},React.createElement("i",{className:"fa fa-circle online"})," ",e.value.timestamp),React.createElement("span",{className:"message-data-time"},e.value.name)),React.createElement("div",{className:"message my-message"},e.value.text))}function Chat(e){return e.value.map(function(e){return e.user==self_user_id?React.createElement(Reply,{value:e,key:e.doubtId}):React.createElement(Response,{value:e,key:e.doubtId})})}window.onfocus=function(){isTabActive=!0},window.onblur=function(){isTabActive=!1};var SidePanel=function(){_inherits(a,React.Component);var t=_createSuper(a);function a(e){return _classCallCheck(this,a),t.call(this,e)}return _createClass(a,[{key:"render",value:function(){var t=this;return React.createElement("ul",{className:"list scroll-slim"},Object.keys(this.props.chats).map(function(e){return React.createElement(ListItem,{key:e,value:t.props.chats[e],action:t.props.action})}))}}]),a}(),Header=function(){_inherits(c,React.Component);var r=_createSuper(c);function c(){var e;_classCallCheck(this,c);for(var t=arguments.length,a=new Array(t),n=0;n<t;n++)a[n]=arguments[n];return _defineProperty(_assertThisInitialized(e=r.call.apply(r,[this].concat(a))),"scrollToBottom",function(){e.messagesEnd.scrollIntoView({behavior:"smooth"})}),e}return _createClass(c,[{key:"componentDidUpdate",value:function(){this.props.chat&&this.scrollToBottom()}},{key:"render",value:function(){var e,t=this,a=this.props.chat;return a?(e=a.user.online?React.createElement("div",null,React.createElement("i",{className:"fa fa-circle online"})," Online"):React.createElement("div",{className:"chat-num-messages"},"last seen ",a.user.lastSeen),React.createElement(React.Fragment,null,React.createElement("div",{className:"chat-header clearfix"},React.createElement("img",{src:a.user.image,alt:"avatar"}),React.createElement("div",{className:"chat-about"},React.createElement("div",{className:"chat-with"},a.user.name," Chat-",a.roomId),e)),React.createElement("div",{className:"chat-history scroll-slim"},React.createElement("ul",null,React.createElement(Chat,{value:a.chats})),React.createElement("div",{style:{float:"left",clear:"both"},ref:function(e){t.messagesEnd=e}})))):React.createElement(React.Fragment,null,React.createElement("div",{className:"chat-header clearfix"}),React.createElement("div",{className:"chat-history scroll-slim"},React.createElement("ul",null)))}}]),c}(),Main=function(){_inherits(n,React.Component);var a=_createSuper(n);function n(e){var t;return _classCallCheck(this,n),_defineProperty(_assertThisInitialized(t=a.call(this,e)),"windowEvent",function(e){"focus"==e.type?t.updateSeen():e.type}),t.state={userId:self_user_id,chats:{},activePanel:"",activeRoomId:0,textValue:""},t.chatSocket=new ReconnectingWebSocket("ws://"+window.location.host+"/ws/chat/"),t.handleSubmit=t.handleSubmit.bind(_assertThisInitialized(t)),t.handleChange=t.handleChange.bind(_assertThisInitialized(t)),t.submitOnEnter=t.submitOnEnter.bind(_assertThisInitialized(t)),t.updateSeen=t.updateSeen.bind(_assertThisInitialized(t)),t}return _createClass(n,[{key:"serialize_rooms",value:function(e){var t=this;e.forEach(function(e){return t.serialize_room(e)})}},{key:"serialize_room",value:function(e){var t,a,n;e.hasOwnProperty("id")&&(t={},a={},e.hasOwnProperty("student")&&e.student&&e.student.id!=this.state.userId&&(t.id=e.student.id,t.name=e.student.email,t.image=e.student.image,t.lastSeen=e.student.lastSeen,t.online=e.student.online),e.hasOwnProperty("teacher")&&e.teacher&&e.teacher.id!=this.state.userId&&(t.id=e.teacher.id,t.name=e.teacher.email,t.image=e.teacher.image,t.lastSeen=e.teacher.lastSeen,t.online=e.teacher.online),e.hasOwnProperty("user")&&(t=e.user),e.hasOwnProperty("doubt")&&e.doubt.forEach(function(e){e.hasOwnProperty("doubtId")&&(a["chat_".concat(e.doubtId)]=e)}),n=encodeRoomId(e.id),this.setState(_objectSpread(_objectSpread({},this.state),{},{chats:_objectSpread(_objectSpread({},this.state.chats),{},_defineProperty({},n,{roomId:e.id,isActive:!1,unseenCount:e.unseenCount,user:t,chats:e.doubt}))})))}},{key:"updateLiveStatus",value:function(e){var t=encodeRoomId(e.id);console.log(e),this.state.chats[t]&&e.user.id!==this.state.userId&&this.setState(_objectSpread(_objectSpread({},this.state),{},{chats:_objectSpread(_objectSpread({},this.state.chats),{},_defineProperty({},t,_objectSpread(_objectSpread({},this.state.chats[t]),{},{user:_objectSpread(_objectSpread({},this.state.chats[t].user),e.user)})))}))}},{key:"componentDidMount",value:function(){var t=this;fetch("/room").then(function(e){return e.json()}).then(function(e){t.serialize_rooms(e)}).catch(function(e){return console.log(e)}),this.chatSocket.onopen=function(e){},this.chatSocket.onmessage=function(e){return t.chatSocketMessage(e)},window.addEventListener("focus",this.windowEvent),window.addEventListener("blur",this.windowEvent)}},{key:"chatSocketMessage",value:function(e){var t,a,n,r=this;"data"in e&&(t=(e=JSON.parse(e.data)).message,"status"===e.type?this.updateLiveStatus(t):"seenStatus"==e.type?(console.log(e),a=encodeRoomId(t.roomId),this.setState(_objectSpread(_objectSpread({},this.state),{},{chats:_objectSpread(_objectSpread({},this.state.chats),{},_defineProperty({},a,_objectSpread(_objectSpread({},this.state.chats[a]),{},{chats:this.state.chats[a].chats.map(function(e){return _objectSpread(_objectSpread({},e),{},{seen:!0})}),unseenCount:0})))}))):"message"===e.type&&(console.log(e),n=encodeRoomId(t.roomId),console.log(n),this.setState(_objectSpread(_objectSpread({},this.state),{},{chats:_objectSpread(_objectSpread({},this.state.chats),{},_defineProperty({},n,_objectSpread(_objectSpread({},this.state.chats[n]),{},{chats:[].concat(_toConsumableArray(this.state.chats[n].chats),[t]),unseenCount:n===this.state.activePanel?this.state.chats[n].unseenCount:this.state.chats[n].unseenCount+1})))}),function(){t.roomId===r.state.activeRoomId&&t.user!==r.state.userId&&r.updateSeen()}),t.roomId===this.state.activeRoomId&&isTabActive||playSound()))}},{key:"clickHandeler",value:function(e){var t=this,a=encodeRoomId(e),n=this.state.activePanel;a!=n&&this.setState(_objectSpread(_objectSpread({},this.state),{},{activePanel:a,activeRoomId:e,chats:_objectSpread(_objectSpread({},this.state.chats),function(){if(n){var e={};return _defineProperty(e,a,_objectSpread(_objectSpread({},t.state.chats[a]),{},{isActive:!0})),_defineProperty(e,n,_objectSpread(_objectSpread({},t.state.chats[n]),{},{isActive:!1})),e}return _defineProperty({},a,_objectSpread(_objectSpread({},t.state.chats[a]),{},{isActive:!0}))}())}),function(){t.updateSeen()})}},{key:"updateSeen",value:function(){isTabActive&&this.chatSocket.send(JSON.stringify({type:"seenStatus",roomId:this.state.activeRoomId}))}},{key:"submitOnEnter",value:function(e){13!==e.keyCode||e.shiftKey||this.handleSubmit(e)}},{key:"handleChange",value:function(e){0!=this.state.activeRoomId&&this.setState(_objectSpread(_objectSpread({},this.state),{},{textValue:e.target.value}))}},{key:"handleSubmit",value:function(e){0!==this.state.activeRoomId&&this.state.textValue&&(this.chatSocket.send(JSON.stringify({type:"message",text:this.state.textValue,roomId:this.state.activeRoomId})),this.setState(_objectSpread(_objectSpread({},this.state),{},{textValue:""}))),e.preventDefault()}},{key:"render",value:function(){var t=this,e=Object.keys(this.state.chats).filter(function(e){return 1==t.state.chats[e].isActive});return React.createElement("div",{className:"container clearfix"},React.createElement("div",{className:"people-list",id:"people-list"},React.createElement("div",{className:"search"},React.createElement("input",{type:"text",placeholder:"search"}),React.createElement("i",{className:"fa fa-search"})),React.createElement(SidePanel,{chats:this.state.chats,action:function(){return t.clickHandeler.apply(t,arguments)}})),React.createElement("div",{className:"chat"},React.createElement(Header,{chat:0!=e.length?this.state.chats[e]:"",updateSeen:function(){return t.updateSeen.apply(t,arguments)}}),React.createElement("div",{className:"chat-message clearfix"},React.createElement("form",{onSubmit:this.handleSubmit},React.createElement("textarea",{onKeyDown:this.submitOnEnter,value:this.state.textValue,onChange:this.handleChange,placeholder:"Type your message",rows:2}),React.createElement("i",{className:"fa fa-file-o"}),"    ",React.createElement("i",{className:"fa fa-file-image-o"}),React.createElement("button",{type:"submit"},"Send")))))}}]),n}();ReactDOM.render(React.createElement(Main,null),document.getElementById("root"));